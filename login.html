<!DOCTYPE html>
<html data-bs-theme="light" lang="en" style="width: 98%">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
        <title>Login</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
            crossorigin="anonymous"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />
        <script src="https://kit.fontawesome.com/f99dffaa0d.js" crossorigin="anonymous"></script>

        <!-- Bootstrap JS and Popper.js (required for Bootstrap) -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Firebase JS SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
        <link rel="stylesheet" href="styles.css" />
    </head>

    <body>
        <section class="position-relative" style="padding: 5%">
            <div class="card" style="width: 100%; height: 100%; padding: 0; border-radius: 26px">
                <div class="row" style="width: auto; height: auto; margin: 0px">
                    <div class="col" style="padding-left: 15px; width: 100%; height: 100%; margin: 10%">
                        <form class="text-center" id="loginForm" method="post" style="position: relative; transform: translate(-247px); margin: 0px; width: 70%; height: 100%; padding-left: 30%">
                            <h1 style="text-align: left; font-weight: bold; padding-bottom: 5%">Login</h1>
                            <div class="mb-3">
                                <input class="text-input" type="email" name="email" id="inputEmail" placeholder="Email" />
                                <div class="error-message" id="emailErrorMessage"></div>
                            </div>
                            <div class="mb-3 password-container">
                                <input class="text-input" type="password" name="password" id="inputPassword" placeholder="Password" />
                                <i class="far fa-eye-slash show-password-btn" id="showPasswordBtn"></i>
                            </div>
                            <div class="error-message" id="passwordErrorMessage"></div>

                            <div class="mb-3">
                                <button class="submit-btn" type="submit" style="position: sticky; transform: translate(50%)">Login</button>
                            </div>
                            <p class="text-muted" style="transform: translate(30%)">Or</p>
                            <div>
                                <div class="card google-card" id="login_google">
                                    <div class="card-body google-card-body">
                                        <i class="fa-brands fa-google fa-l google-icon" style="margin-right: 0px" 0px;></i>
                                        <h6 class="text-muted card-subtitle mb-2 google-text" style="font-family: Product Sans">Login with Google</h6>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Image Carousel -->
                    <div class="col-md-6 col-xl-4 my-5 pe-5" style="border-radius: 20px;">
                        <div class="carousel slide" data-bs-ride="carousel" id="carousel-1">
                            <div class="carousel-inner" style="border-radius: 26px; border-style: solid">
                                <!-- Carousel Indicators (Dots) -->
                                <ol class="carousel-indicators" style="list-style-type: none">
                                    <li data-bs-target="#carousel-1" data-bs-slide-to="0" class="active"></li>
                                    <li data-bs-target="#carousel-1" data-bs-slide-to="1"></li>
                                    <li data-bs-target="#carousel-1" data-bs-slide-to="2"></li>
                                </ol>

                                <div class="carousel-item active">
                                    <img class="w-100 d-block" src="https://source.unsplash.com/random/800x600/?technology" alt="Slide Image" style="height: 602px; width: 650px" />
                                </div>
                                <div class="carousel-item">
                                    <img class="w-100 d-block" src="https://source.unsplash.com/random/800x600/?nature" alt="Slide Image" style="height: 602px; width: 650px" />
                                </div>
                                <div class="carousel-item">
                                    <img class="w-100 d-block" src="https://source.unsplash.com/random/800x600/?animals" alt="Slide Image" style="height: 602px; width: 650px" />
                                </div>
                            </div>

                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-1" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-1" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </body>

    <script>
        document.getElementById("showPasswordBtn").addEventListener("click", togglePasswordVisibility);

        function togglePasswordVisibility() {
            var passwordInput = document.getElementById("inputPassword");
            var showPasswordBtn = document.getElementById("showPasswordBtn");

            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                showPasswordBtn.classList.remove("far", "fa-eye-slash");
                showPasswordBtn.classList.add("far", "fa-eye");
            } else {
                passwordInput.type = "password";
                showPasswordBtn.classList.remove("far", "fa-eye");
                showPasswordBtn.classList.add("far", "fa-eye-slash");
            }
        }
    </script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBasI3Cfcv2NuSSdL9rUI__pYs-xUN7nm8",
            authDomain: "csad-restaurant-pos.firebaseapp.com",
            databaseURL: "https://csad-restaurant-pos-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "csad-restaurant-pos",
            storageBucket: "csad-restaurant-pos.appspot.com",
            messagingSenderId: "964704635393",
            appId: "1:964704635393:web:7a616e7814cb9c42348e00",
            measurementId: "G-SW0P8CW3WQ",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth();

        document.getElementById("loginForm").addEventListener("submit", (e) => {
            e.preventDefault(); // Prevent default form submission, as you want to handle Firebase submission

            var email = document.getElementById("inputEmail").value;
            var password = document.getElementById("inputPassword").value;

            const auth = getAuth();
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;

                    const dt = new Date();
                    update(ref(database, "users/" + user.uid), {
                        last_login: dt,
                    });
                    alert("User has been logged in!");
                    // ...
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    if (errorCode === "auth/user-not-found") {
                        document.getElementById("emailErrorMessage").innerText = "User not found. Please check your email and try again.";
                        document.getElementById("inputEmail").classList.add("input-error");
                    } else if (errorCode === "auth/invalid-credential") {
                        document.getElementById("passwordErrorMessage").innerText = "Incorrect password. Please try again.";
                        document.getElementById("inputPassword").classList.add("input-error");
                    } else if (errorCode === "auth/too-many-requests") {
                        document.getElementById("emailErrorMessage").innerText =
                            "Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.";
                        document.getElementById("inputEmail").classList.add("input-error");
                    } else if (document.getElementById("inputPassword").value === "") {
                        document.getElementById("passwordErrorMessage").innerText = "Please key in a password!";
                        document.getElementById("inputPassword").classList.add("input-error");
                    } else {
                        document.getElementById("emailErrorMessage").innerText = errorMessage;
                        document.getElementById("inputEmail").classList.add("input-error");
                    }
                });
        });

        const provider = new GoogleAuthProvider();
        let dt, email;

        document.getElementById("login_google").addEventListener("click", (e) => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const token = credential.accessToken;
                    // The signed-in user info.
                    const user = result.user;
                    // IdP data available using getAdditionalUserInfo(result)
                    dt = new Date();
                    email = user.email;

                    update(ref(database, "users/" + user.uid), {
                        email: email,
                        last_login: dt,
                    });
                    alert("User has been logged in via Google!");
                    // ...
                })
                .catch((error) => {
                    // Handle Errors here.
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    // The email of the user's account used.
                    const email = error.customData.email;
                    // The AuthCredential type that was used.
                    const credential = GoogleAuthProvider.credentialFromError(error);
                    // ...
                });
        });

        const user = auth.currentUser;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/auth.user
                const uid = user.uid;
                // ...
            } else {
                // User is signed out
                // ...
            }
        });
    </script>
</html>

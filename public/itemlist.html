<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/f99dffaa0d.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>
    <link href="styles.css" rel="stylesheet" />
    <title>Item List</title>
  </head>
  <body>
    <!-- Navbar -->
    <script>
      document.write('<div id="topnavbar-container"></div>');
      fetch("topnavbar.html")
        .then((response) => response.text())
        .then((data) => (document.getElementById("topnavbar-container").innerHTML = data));
    </script>

    <div class="container mt-5 mb-5">
      <h2 class="mb-3">Today's Top Items</h2>
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col" class="col-1">ID</th>
            <th scope="col" class="col-1">Item Name</th>
            <th scope="col" class="col-1">Price</th>
            <th scope="col" class="col-1">Category</th>
            <th scope="col" class="col-3">Details</th>
          </tr>
        </thead>
      </table>
    </div>

    <div class="container mb-5">
      <div class="row mb-3">
        <div class="col">
          <h2>Current Menu Items</h2>
        </div>
        <div class="col-auto">
          <a class="btn btn-outline-primary" href="add_item.html">Add Item</a>
        </div>
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="burgers-tab" data-bs-toggle="tab" data-bs-target="#burgers" type="button" role="tab" aria-controls="burgers" aria-selected="true">Burgers</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tacos-tab" data-bs-toggle="tab" data-bs-target="#tacos" type="button" role="tab" aria-controls="tacos" aria-selected="false">Tacos</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="sides-tab" data-bs-toggle="tab" data-bs-target="#sides" type="button" role="tab" aria-controls="sides" aria-selected="false">Sides</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="desserts-tab" data-bs-toggle="tab" data-bs-target="#desserts" type="button" role="tab" aria-controls="desserts" aria-selected="false">Desserts</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="drinks-tab" data-bs-toggle="tab" data-bs-target="#drinks" type="button" role="tab" aria-controls="drinks" aria-selected="false">Drinks</button>
        </li>
        <!-- Add tabs for other categories -->
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="burgers" role="tabpanel" aria-labelledby="burgers-tab">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="col-1">ID</th>
                <th scope="col" class="col-1">Item Name</th>
                <th scope="col" class="col-3">Description</th>
                <th scope="col" class="col-1">Price</th>
                <th scope="col" class="col-1">Category</th>
                <th scope="col" class="col-3">Actions</th>
              </tr>
            </thead>
            <tbody id="burgers-item-body">
              <!-- Table rows will be dynamically populated -->
            </tbody>
          </table>
        </div>

        <!-- For tacos -->
        <div class="tab-pane fade" id="tacos" role="tabpanel" aria-labelledby="tacos-tab">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="col-1">ID</th>
                <th scope="col" class="col-1">Item Name</th>
                <th scope="col" class="col-3">Description</th>
                <th scope="col" class="col-1">Price</th>
                <th scope="col" class="col-1">Category</th>
                <th scope="col" class="col-3">Actions</th>
              </tr>
            </thead>
            <tbody id="tacos-item-body">
              <!-- Table rows will be dynamically populated -->
            </tbody>
          </table>
        </div>

        <!-- For sides -->
        <div class="tab-pane fade" id="sides" role="tabpanel" aria-labelledby="sides-tab">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="col-1">ID</th>
                <th scope="col" class="col-1">Item Name</th>
                <th scope="col" class="col-3">Description</th>
                <th scope="col" class="col-1">Price</th>
                <th scope="col" class="col-1">Category</th>
                <th scope="col" class="col-3">Actions</th>
              </tr>
            </thead>
            <tbody id="sides-item-body">
              <!-- Table rows will be dynamically populated -->
            </tbody>
          </table>
        </div>

        <!-- For desserts -->
        <div class="tab-pane fade" id="desserts" role="tabpanel" aria-labelledby="desserts-tab">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="col-1">ID</th>
                <th scope="col" class="col-1">Item Name</th>
                <th scope="col" class="col-3">Description</th>
                <th scope="col" class="col-1">Price</th>
                <th scope="col" class="col-1">Category</th>
                <th scope="col" class="col-3">Actions</th>
              </tr>
            </thead>
            <tbody id="desserts-item-body">
              <!-- Table rows will be dynamically populated -->
            </tbody>
          </table>
        </div>

        <!-- For drinks -->
        <div class="tab-pane fade" id="drinks" role="tabpanel" aria-labelledby="drinks-tab">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="col-1">ID</th>
                <th scope="col" class="col-1">Item Name</th>
                <th scope="col" class="col-3">Description</th>
                <th scope="col" class="col-1">Price</th>
                <th scope="col" class="col-1">Category</th>
                <th scope="col" class="col-3">Actions</th>
              </tr>
            </thead>
            <tbody id="drinks-item-body">
              <!-- Table rows will be dynamically populated -->
            </tbody>
          </table>
        </div>

        <!-- Add tab panes for other categories -->
      </div>
    </div>

    <!-- Edit Modal HTML -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <div class="mb-3">
                <label for="itemName" class="form-label">Item Name</label>
                <input type="text" class="form-control" id="editItemName" required />
              </div>
              <div class="mb-3">
                <label for="itemDescription" class="form-label">Description</label>
                <textarea class="form-control" id="editItemDescription" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label for="itemPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="editItemPrice" step="0.01" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Feedback Table -->
    <div class="container mt-5 mb-5">
      <div class="row mb-3">
        <div class="col">
          <h2>Recent Feedback</h2>
        </div>
      </div>

      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Message</th>
            <th scope="col">Outlet</th>
            <th scope="col">Timestamp</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="feedback-table-body">
          <!-- Table will be dynamically populated -->
        </tbody>
      </table>
    </div>

    <!-- Add Admin Modal HTML -->
    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addAdminModalLabel">Add Admin</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addAdminForm">
              <div class="mb-3">
                <label for="adminEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="adminEmail" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveAdminBtn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-5 mb-5">
      <div class="row mb-3">
        <div class="col">
          <h2>Manage Admins</h2>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAdminModal">Add Admin</button>
        </div>
      </div>

      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="admins-table-body">
          <!-- Table will be dynamically populated -->
        </tbody>
      </table>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
      import { collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBasI3Cfcv2NuSSdL9rUI__pYs-xUN7nm8",
        authDomain: "csad-restaurant-pos.firebaseapp.com",
        databaseURL: "https://csad-restaurant-pos-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "csad-restaurant-pos",
        storageBucket: "csad-restaurant-pos.appspot.com",
        messagingSenderId: "964704635393",
        appId: "1:964704635393:web:7a616e7814cb9c42348e00",
        measurementId: "G-SW0P8CW3WQ",
      };

      const firebaseApp = firebase.initializeApp(firebaseConfig);
      const db = firebaseApp.firestore();
      const userdb = firebase.database();

      function fetchMenuItems(category) {
        db.collection("categories")
          .doc(category)
          .collection("items")
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((itemDoc) => {
              const item = itemDoc.data();
              addItemToTable(item, category, itemDoc.id);
            });
          })
          .catch((error) => {
            console.error("Error fetching menu items: ", error);
          });
      }

      function addItemToTable(item, category, id) {
        const tableBody = document.getElementById(`${category}-item-body`);
        const row = tableBody.insertRow();
        row.innerHTML = `
                <td>${id}</td>
                <td>${item.name}</td>
                <td>${item.description}</td>
                <td>$${item.price.toFixed(2)}</td>
                <td>${category}</td>
                <td><button class="btn btn-outline-secondary edit-btn" data-id="${id}">Edit</button> <button class="btn btn-outline-danger delete-btn" data-id="${id}" data-category="${category}">Delete</button></td>
            `;

        // Add event listener for edit button
        const editButton = row.querySelector(".edit-btn");
        editButton.addEventListener("click", () => {
          // Call function to handle edit action
          handleEditItem(id, category);
        });

        // Add event listener for delete button
        const deleteButton = row.querySelector(".delete-btn");
        deleteButton.addEventListener("click", () => {
          // Call function to handle delete action
          handleDeleteItem(id, category);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const activeTabId = document.querySelector(".nav-link.active").getAttribute("data-bs-target").replace("#", "");
        const category = activeTabId.split("-")[0]; // Extract category from tab ID
        fetchMenuItems(category);
      });

      document.querySelectorAll(".nav-link").forEach((tab) => {
        tab.addEventListener("click", () => {
          const category = tab.getAttribute("data-bs-target").replace("#", "").split("-")[0]; // Extract category from tab ID
          const tableBody = document.getElementById(`${category}-item-body`);
          tableBody.innerHTML = ""; // Clear table
          fetchMenuItems(category);
        });
      });

      function handleDeleteItem(id, category) {
        const confirmDelete = confirm("Are you sure you want to delete this item?");
        if (confirmDelete) {
          // Delete the item from the Firestore database
          db.collection("categories")
            .doc(category)
            .collection("items")
            .doc(id)
            .delete()
            .then(() => {
              console.log("Item deleted successfully");
              // If deletion is successful, remove the item from the UI
              const rowToDelete = document.getElementById(`${category}-item-${id}`);
              rowToDelete.remove();
            })
            .catch((error) => {
              console.error("Error deleting item: ", error);
            });
        }
      }

      function handleEditItem(id, category) {
        // Fetch the item details from Firestore
        db.collection("categories")
          .doc(category)
          .collection("items")
          .doc(id)
          .get()
          .then((doc) => {
            if (doc.exists) {
              const itemData = doc.data();
              // Fill the edit modal fields with the item details
              document.getElementById("editItemName").value = itemData.name;
              document.getElementById("editItemDescription").value = itemData.description;
              document.getElementById("editItemPrice").value = itemData.price.toFixed(2);

              // Show the edit modal
              const editModal = new bootstrap.Modal(document.getElementById("editModal"));
              editModal.show();

              // Save changes button click event
              document.getElementById("saveChangesBtn").addEventListener("click", () => {
                const newName = document.getElementById("editItemName").value;
                const newDescription = document.getElementById("editItemDescription").value;
                const newPrice = parseFloat(document.getElementById("editItemPrice").value);

                // Update the item in Firestore
                db.collection("categories")
                  .doc(category)
                  .collection("items")
                  .doc(id)
                  .update({
                    name: newName,
                    description: newDescription,
                    price: newPrice,
                  })
                  .then(() => {
                    console.log("Item updated successfully");
                    // Close the edit modal
                    editModal.hide();
                    // Update the item details in the UI
                    const rowToUpdate = document.getElementById(`${category}-item-${id}`);
                    rowToUpdate.cells[1].textContent = newName;
                    rowToUpdate.cells[2].textContent = newDescription;
                    rowToUpdate.cells[3].textContent = `$${newPrice.toFixed(2)}`;
                  })
                  .catch((error) => {
                    console.error("Error updating item: ", error);
                  });
              });
            } else {
              console.error("No such document!");
            }
          })
          .catch((error) => {
            console.error("Error getting document:", error);
          });
      }

      // Function to fetch feedback
      function fetchFeedback() {
        const feedbackTableBody = document.getElementById("feedback-table-body");
        feedbackTableBody.innerHTML = ""; // Clear existing feedback

        db.collection("feedback")
          .orderBy("timestamp", "desc")
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              const feedback = doc.data();
              const timestamp = feedback.timestamp ? feedback.timestamp.toDate().toLocaleString() : "No timestamp";
              const feedbackRow = document.createElement("tr"); // Create a table row element
              feedbackRow.innerHTML = `
          <td>${feedback.name}</td>
          <td>${feedback.email}</td>
          <td>${feedback.message}</td>
          <td>${feedback.outlet}</td>
          <td>${timestamp}</td>
          <td>
            <button class="btn btn-outline-secondary reply-button" data-email="${feedback.email}">Reply</button>
          </td>
        `;

              feedbackTableBody.appendChild(feedbackRow); // Append the row to the table body

              // Find the button in the created row and add an event listener
              const replyButton = feedbackRow.querySelector(".reply-button");
              replyButton.addEventListener("click", function () {
                window.location.href = `mailto:${feedback.email}`;
              });
            });
          })
          .catch((error) => {
            console.error("Error fetching feedback: ", error);
          });
      }

      // Call fetchFeedback on DOMContentLoaded
      document.addEventListener("DOMContentLoaded", fetchFeedback);

      function addReplyButtonListeners() {
        // Select all buttons with the 'reply-button' class and attach a click event listener
        document.querySelectorAll(".reply-button").forEach((button) => {
          button.addEventListener("click", (event) => {
            const emailAddress = event.target.getAttribute("data-email");
            replyToFeedback(emailAddress);
          });
        });
      }

      function replyToFeedback(emailAddress) {
        window.location.href = `mailto:${emailAddress}`;
      }

      

      // Function to fetch and display admin users
      function fetchAdmins() {
        const adminsTableBody = document.getElementById("admins-table-body");
        adminsTableBody.innerHTML = ""; // Clear existing data

        userdb.ref("users").once("value", (snapshot) => {
          snapshot.forEach((childSnapshot) => {
            const user = childSnapshot.val();
            if (user.admin === true) {
              const row = `
                    <tr>
                        <td>${childSnapshot.key}</td>
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>${user.email}</td>
                        <td>
                            <button class="btn btn-outline-danger delete-admin-btn" data-id="${childSnapshot.key}">Delete</button>
                        </td>
                    </tr>
                `;
              adminsTableBody.innerHTML += row;
            }
          });
        });

        // Check if the currently signed-in user is an admin
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            userdb.ref(`users/${user.uid}`).once("value", (snapshot) => {
              const currentUser = snapshot.val();
              if (!currentUser.admin) {
                // If the current user is not an admin, show an alert and redirect after OK
                alert("You are not authorized to view this page.");
                window.location.href = "/index.html";
              }
            });
          } else {
            // If no user is signed in, redirect to the login page
            window.location.href = "/login.html";
          }
        });
      }

      // Add event listener for saving admin button
      document.getElementById("saveAdminBtn").addEventListener("click", () => {
        const adminEmail = document.getElementById("adminEmail").value;
        // Find the user with the specified email
        userdb
          .ref("users")
          .orderByChild("email")
          .equalTo(adminEmail)
          .once("value", (snapshot) => {
            snapshot.forEach((childSnapshot) => {
              const userId = childSnapshot.key;
              // Set the "admin" field to true for the selected user
              userdb.ref(`users/${userId}`).update(
                {
                  admin: true,
                },
                (error) => {
                  if (error) {
                    console.error("Error adding admin: ", error);
                  } else {
                    console.log("Admin added successfully");
                    // Close the modal
                    const addAdminModal = bootstrap.Modal.getInstance(document.getElementById("addAdminModal"));
                    addAdminModal.hide();
                    // Fetch and display updated admin list
                    fetchAdmins();
                  }
                }
              );
            });
          });
      });

      // Add event listener for deleting admin button
      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("delete-admin-btn")) {
          const adminId = event.target.getAttribute("data-id");
          if (confirm("Are you sure you want to delete this admin?")) {
            // Set the "admin" field to false for the selected user
            userdb.ref(`users/${adminId}`).update(
              {
                admin: false,
              },
              (error) => {
                if (error) {
                  console.error("Error deleting admin: ", error);
                } else {
                  console.log("Admin deleted successfully");
                  // Fetch and display updated admin list
                  fetchAdmins();
                }
              }
            );
          }
        }
      });

      // Fetch and display admin list on page load
      document.addEventListener("DOMContentLoaded", fetchAdmins);
    </script>
  </body>
</html>
